package okhttp3.internal.http;

import b.d;
import b.l;
import java.net.ProtocolException;
import okhttp3.Interceptor;
import okhttp3.Request;
import okhttp3.Response;
import okhttp3.ResponseBody;
import okhttp3.internal.Util;
import okhttp3.internal.connection.RealConnection;
import okhttp3.internal.connection.StreamAllocation;

public final class CallServerInterceptor implements Interceptor {
  private final boolean forWebSocket;
  
  public CallServerInterceptor(boolean paramBoolean) { this.forWebSocket = paramBoolean; }
  
  public Response intercept(Interceptor.Chain paramChain) {
    Response.Builder builder1;
    RealInterceptorChain realInterceptorChain = (RealInterceptorChain)paramChain;
    HttpCodec httpCodec = realInterceptorChain.httpStream();
    StreamAllocation streamAllocation = realInterceptorChain.streamAllocation();
    RealConnection realConnection = (RealConnection)realInterceptorChain.connection();
    Request request = realInterceptorChain.request();
    long l = System.currentTimeMillis();
    realInterceptorChain.eventListener().requestHeadersStart(realInterceptorChain.call());
    httpCodec.writeRequestHeaders(request);
    realInterceptorChain.eventListener().requestHeadersEnd(realInterceptorChain.call(), request);
    boolean bool = HttpMethod.permitsRequestBody(request.method());
    Interceptor.Chain chain = null;
    Response.Builder builder2 = null;
    paramChain = chain;
    if (bool) {
      paramChain = chain;
      if (request.body() != null) {
        if ("100-continue".equalsIgnoreCase(request.header("Expect"))) {
          httpCodec.flushRequest();
          realInterceptorChain.eventListener().responseHeadersStart(realInterceptorChain.call());
          builder2 = httpCodec.readResponseHeaders(true);
        } 
        if (builder2 == null) {
          realInterceptorChain.eventListener().requestBodyStart(realInterceptorChain.call());
          CountingSink countingSink = new CountingSink(httpCodec.createRequestBody(request, request.body().contentLength()));
          d d = l.a(countingSink);
          request.body().writeTo(d);
          d.close();
          realInterceptorChain.eventListener().requestBodyEnd(realInterceptorChain.call(), countingSink.successfulCount);
          builder1 = builder2;
        } else {
          builder1 = builder2;
          if (!realConnection.isMultiplexed()) {
            streamAllocation.noNewStreams();
            builder1 = builder2;
          } 
        } 
      } 
    } 
    httpCodec.finishRequest();
    builder2 = builder1;
    if (builder1 == null) {
      realInterceptorChain.eventListener().responseHeadersStart(realInterceptorChain.call());
      builder2 = httpCodec.readResponseHeaders(false);
    } 
    ResponseBody responseBody = builder2.request(request).handshake(streamAllocation.connection().handshake()).sentRequestAtMillis(l).receivedResponseAtMillis(System.currentTimeMillis()).build();
    int j = responseBody.code();
    int i = j;
    if (j == 100) {
      responseBody = httpCodec.readResponseHeaders(false).request(request).handshake(streamAllocation.connection().handshake()).sentRequestAtMillis(l).receivedResponseAtMillis(System.currentTimeMillis()).build();
      i = responseBody.code();
    } 
    realInterceptorChain.eventListener().responseHeadersEnd(realInterceptorChain.call(), responseBody);
    if (this.forWebSocket && i == 101) {
      builder2 = responseBody.newBuilder();
      responseBody = Util.EMPTY_RESPONSE;
    } else {
      builder2 = responseBody.newBuilder();
      responseBody = httpCodec.openResponseBody(responseBody);
    } 
    Response response = builder2.body(responseBody).build();
    if ("close".equalsIgnoreCase(response.request().header("Connection")) || "close".equalsIgnoreCase(response.header("Connection")))
      streamAllocation.noNewStreams(); 
    if ((i != 204 && i != 205) || response.body().contentLength() <= 0L)
      return response; 
    StringBuilder stringBuilder = new StringBuilder();
    stringBuilder.append("HTTP ");
    stringBuilder.append(i);
    stringBuilder.append(" had non-zero Content-Length: ");
    stringBuilder.append(response.body().contentLength());
    throw new ProtocolException(stringBuilder.toString());
  }
}
