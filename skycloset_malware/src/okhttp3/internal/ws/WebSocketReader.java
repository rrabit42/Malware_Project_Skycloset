package okhttp3.internal.ws;

import b.c;
import b.e;
import java.io.IOException;
import java.net.ProtocolException;
import java.util.concurrent.TimeUnit;

final class WebSocketReader {
  boolean closed;
  
  private final c controlFrameBuffer = new c();
  
  final FrameCallback frameCallback;
  
  long frameLength;
  
  final boolean isClient;
  
  boolean isControlFrame;
  
  boolean isFinalFrame;
  
  private final c.a maskCursor;
  
  private final byte[] maskKey;
  
  private final c messageFrameBuffer = new c();
  
  int opcode;
  
  final e source;
  
  WebSocketReader(boolean paramBoolean, e parame, FrameCallback paramFrameCallback) {
    if (parame != null) {
      if (paramFrameCallback != null) {
        c.a a1;
        this.isClient = paramBoolean;
        this.source = parame;
        this.frameCallback = paramFrameCallback;
        paramFrameCallback = null;
        if (paramBoolean) {
          parame = null;
        } else {
          a1 = new byte[4];
        } 
        this.maskKey = a1;
        if (paramBoolean) {
          FrameCallback frameCallback1 = paramFrameCallback;
        } else {
          a1 = new c.a();
        } 
        this.maskCursor = a1;
        return;
      } 
      throw new NullPointerException("frameCallback == null");
    } 
    throw new NullPointerException("source == null");
  }
  
  private void readControlFrame() {
    StringBuilder stringBuilder;
    long l = this.frameLength;
    if (l > 0L) {
      this.source.a(this.controlFrameBuffer, l);
      if (!this.isClient) {
        this.controlFrameBuffer.a(this.maskCursor);
        this.maskCursor.a(0L);
        WebSocketProtocol.toggleMask(this.maskCursor, this.maskKey);
        this.maskCursor.close();
      } 
    } 
    switch (this.opcode) {
      default:
        stringBuilder = new StringBuilder();
        stringBuilder.append("Unknown control opcode: ");
        stringBuilder.append(Integer.toHexString(this.opcode));
        throw new ProtocolException(stringBuilder.toString());
      case 10:
        this.frameCallback.onReadPong(this.controlFrameBuffer.q());
        return;
      case 9:
        this.frameCallback.onReadPing(this.controlFrameBuffer.q());
        return;
      case 8:
        break;
    } 
    short s = 1005;
    String str = "";
    l = this.controlFrameBuffer.a();
    if (l != 1L) {
      if (l != 0L) {
        s = this.controlFrameBuffer.j();
        str = this.controlFrameBuffer.r();
        String str1 = WebSocketProtocol.closeCodeExceptionMessage(s);
        if (str1 != null)
          throw new ProtocolException(str1); 
      } 
      this.frameCallback.onReadClose(s, str);
      this.closed = true;
      return;
    } 
    throw new ProtocolException("Malformed close payload length of 1.");
  }
  
  private void readHeader() {
    if (!this.closed) {
      long l = this.source.timeout().timeoutNanos();
      this.source.timeout().clearTimeout();
      try {
        byte b1 = this.source.i();
        byte b2 = b1 & 0xFF;
        this.source.timeout().timeout(l, TimeUnit.NANOSECONDS);
        this.opcode = b2 & 0xF;
        byte b4 = 1;
        if ((b2 & 0x80) != 0) {
          b3 = 1;
        } else {
          b3 = 0;
        } 
        this.isFinalFrame = b3;
        if ((b2 & 0x8) != 0) {
          b3 = 1;
        } else {
          b3 = 0;
        } 
        this.isControlFrame = b3;
        if (!this.isControlFrame || this.isFinalFrame) {
          boolean bool;
          if ((b2 & 0x40) != 0) {
            b1 = 1;
          } else {
            b1 = 0;
          } 
          if ((b2 & 0x20) != 0) {
            bool = true;
          } else {
            bool = false;
          } 
          if ((b2 & 0x10) != 0) {
            b2 = 1;
          } else {
            b2 = 0;
          } 
          if (b1 == 0 && !bool && b2 == 0) {
            b1 = this.source.i() & 0xFF;
            if ((b1 & 0x80) != 0) {
              b3 = b4;
            } else {
              b3 = 0;
            } 
            boolean bool1 = this.isClient;
            if (b3 == bool1) {
              String str;
              if (bool1) {
                str = "Server-sent frames must not be masked.";
              } else {
                str = "Client-sent frames must be masked.";
              } 
              throw new ProtocolException(str);
            } 
            this.frameLength = (b1 & 0x7F);
            l = this.frameLength;
            if (l == 126L) {
              this.frameLength = this.source.j() & 0xFFFFL;
            } else if (l == 127L) {
              this.frameLength = this.source.l();
              if (this.frameLength < 0L) {
                StringBuilder stringBuilder = new StringBuilder();
                stringBuilder.append("Frame length 0x");
                stringBuilder.append(Long.toHexString(this.frameLength));
                stringBuilder.append(" > 0x7FFFFFFFFFFFFFFF");
                throw new ProtocolException(stringBuilder.toString());
              } 
            } 
            if (!this.isControlFrame || this.frameLength <= 125L)
              return; 
            throw new ProtocolException("Control frame must be less than 125B.");
          } 
          throw new ProtocolException("Reserved flags are unsupported.");
        } 
        throw new ProtocolException("Control frames must be final.");
      } finally {
        this.source.timeout().timeout(l, TimeUnit.NANOSECONDS);
      } 
    } 
    throw new IOException("closed");
  }
  
  private void readMessage() {
    while (!this.closed) {
      long l = this.frameLength;
      if (l > 0L) {
        this.source.a(this.messageFrameBuffer, l);
        if (!this.isClient) {
          this.messageFrameBuffer.a(this.maskCursor);
          this.maskCursor.a(this.messageFrameBuffer.a() - this.frameLength);
          WebSocketProtocol.toggleMask(this.maskCursor, this.maskKey);
          this.maskCursor.close();
        } 
      } 
      if (this.isFinalFrame)
        return; 
      readUntilNonControlFrame();
      if (this.opcode == 0)
        continue; 
      StringBuilder stringBuilder = new StringBuilder();
      stringBuilder.append("Expected continuation opcode. Got: ");
      stringBuilder.append(Integer.toHexString(this.opcode));
      throw new ProtocolException(stringBuilder.toString());
    } 
    throw new IOException("closed");
  }
  
  private void readMessageFrame() {
    int i = this.opcode;
    if (i == 1 || i == 2) {
      readMessage();
      if (i == 1) {
        this.frameCallback.onReadMessage(this.messageFrameBuffer.r());
        return;
      } 
      this.frameCallback.onReadMessage(this.messageFrameBuffer.q());
      return;
    } 
    StringBuilder stringBuilder = new StringBuilder();
    stringBuilder.append("Unknown opcode: ");
    stringBuilder.append(Integer.toHexString(i));
    throw new ProtocolException(stringBuilder.toString());
  }
  
  private void readUntilNonControlFrame() {
    while (!this.closed) {
      readHeader();
      if (!this.isControlFrame)
        return; 
      readControlFrame();
    } 
  }
  
  void processNextFrame() {
    readHeader();
    if (this.isControlFrame) {
      readControlFrame();
      return;
    } 
    readMessageFrame();
  }
}
